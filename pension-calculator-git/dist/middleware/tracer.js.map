{"version":3,"sources":["../../src/middleware/tracer.js"],"names":["uuidv4","require","CORRELATION_ID_HEADER","CORRELATION_ID_BODY","getCorrelationIdFromRequest","correlationId","req","get","body","RequestInfo","module","exports","options","res","next","obj","logger","info","originalUrl","envVariables","TRACER_ENABLE_REQUEST_LOGGING","method","is","JSON","stringify","query","on","statusCode"],"mappings":";;AAAA;;;;AAEA;;;;;;AADA,IAAMA,SAASC,QAAQ,SAAR,CAAf;;;AAGA,IAAMC,wBAAwB,kBAA9B;AACA,IAAMC,sBAAsB,eAA5B;;AAEA,IAAMC,8BAA8B,SAA9BA,2BAA8B,MAAO;AACzC,MAAIC,gBAAgBC,IAAIC,GAAJ,CAAQL,qBAAR,CAApB;;AAEA,MAAI,OAAOG,aAAP,KAAyB,WAA7B,EAA0C;AACxC,QAAIC,IAAIE,IAAJ,CAASC,WAAT,IAAwBH,IAAIE,IAAJ,CAASC,WAAT,CAAqBN,mBAArB,CAA5B,EAAuE;AACrEE,sBAAgBC,IAAIE,IAAJ,CAASC,WAAT,CAAqBN,mBAArB,CAAhB;AACD;AACF;;AAED,MAAI,OAAOE,aAAP,KAAyB,WAA7B,EAA0C;AACxCA,oBAAgBL,QAAhB;AACA,QAAIM,IAAIE,IAAJ,CAASC,WAAT,IAAwBH,IAAIE,IAAJ,CAASC,WAAT,CAAqBN,mBAArB,CAA5B,EAAuE;AACrEG,UAAIE,IAAJ,CAASC,WAAT,CAAqBN,mBAArB,IAA4CE,aAA5C;AACD;AACF;;AAED,SAAOA,aAAP;AACD,CAjBD;;AAmBAK,OAAOC,OAAP,GAAiB,UAASC,OAAT,EAAkB;AACjC,SAAO,UAASN,GAAT,EAAcO,GAAd,EAAmBC,IAAnB,EAAyB;AAC9B,QAAIC,MAAM,EAAV;AACAA,QAAI,gBAAJ,IAAwBX,4BAA4BE,GAA5B,CAAxB;;AAEAU,qBAAOC,IAAP,4BAAqCX,IAAIY,WAAzC,EAAwDH,GAAxD;;AAEA,QACEI,uBAAaC,6BAAb,IACAd,IAAIe,MAAJ,KAAe,MADf,IAEAf,IAAIgB,EAAJ,CAAO,kBAAP,CAFA,GAGI,IAHJ,GAII,KALN,EAME;AACAN,uBAAOC,IAAP,qBAA8BM,KAAKC,SAAL,CAAelB,IAAIE,IAAnB,CAA9B,EAA0DO,GAA1D;AACAC,uBAAOC,IAAP,qBAA8BM,KAAKC,SAAL,CAAelB,IAAImB,KAAnB,CAA9B,EAA2DV,GAA3D;AACD;;AAEDF,QAAIa,EAAJ,CAAO,QAAP,EAAiB,YAAW;AAC1BV,uBAAOC,IAAP,0BAAmC,KAAKU,UAAxC,EAAsDZ,GAAtD;AACD,KAFD;;AAIAD;AACD,GAtBD;AAuBD,CAxBD","file":"tracer.js","sourcesContent":["import logger from \"../config/logger\";\nconst uuidv4 = require(\"uuid/v4\");\nimport envVariables from \"../envVariables\";\n\nconst CORRELATION_ID_HEADER = \"x-correlation-id\";\nconst CORRELATION_ID_BODY = \"correlationId\";\n\nconst getCorrelationIdFromRequest = req => {\n  let correlationId = req.get(CORRELATION_ID_HEADER);\n\n  if (typeof correlationId === \"undefined\") {\n    if (req.body.RequestInfo && req.body.RequestInfo[CORRELATION_ID_BODY]) {\n      correlationId = req.body.RequestInfo[CORRELATION_ID_BODY];\n    }\n  }\n\n  if (typeof correlationId === \"undefined\") {\n    correlationId = uuidv4();\n    if (req.body.RequestInfo && req.body.RequestInfo[CORRELATION_ID_BODY]) {\n      req.body.RequestInfo[CORRELATION_ID_BODY] = correlationId;\n    }\n  }\n\n  return correlationId;\n};\n\nmodule.exports = function(options) {\n  return function(req, res, next) {\n    let obj = {};\n    obj[\"CORRELATION-ID\"] = getCorrelationIdFromRequest(req);\n\n    logger.info(`Received request URI: ${req.originalUrl}`, obj);\n\n    if (\n      envVariables.TRACER_ENABLE_REQUEST_LOGGING &&\n      req.method === \"POST\" &&\n      req.is(\"application/json\")\n        ? true\n        : false\n    ) {\n      logger.info(`Request body - ${JSON.stringify(req.body)}`, obj);\n      logger.info(`Request body - ${JSON.stringify(req.query)}`, obj);\n    }\n\n    res.on(\"finish\", function() {\n      logger.info(`Response code sent: ${this.statusCode}`, obj);\n    });\n\n    next();\n  };\n};\n"]}